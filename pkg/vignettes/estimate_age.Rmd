---
title: "Performing a simple age estimate"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{estimate_age}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: refs.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(width = 100)
```

```{r setup}
library(wormAge)
```


This document assumes you already have an appropriate sample dataset on hand. 
The data used in the examples is loaded in the [`prepare_data`](prepare_data.html) vignette.

```{r load_dat, echo=F}
load("hend.RData")
```

## Choosing a reference dataset

`wormAge` estimates the developmental age of samples based on correlation with reference time series datasets. 
This means you have to select the proper dataset to run your samples against.
Below is a chart showing the developmental stages and the corresponding datasets available in the package (developmental time is according to the Oudenaarden 20$^\circ$C reference series).

```{r ref_time, echo=F, fig.height=5, fig.width=6, fig.align='center'}
timeline <- function(dat, band.width=.9,
                     ylim=c(0,max(dat$row)), 
                     xlim=range(c(dat$start, dat$end)),
                     cex=1,
                     xlab='time',
                     main="Timeline", 
                     pos=NULL, offset=0,
                     padd=1, lab.col='white',
                     col=NULL, add=FALSE){
  
  nr <- nrow(dat)
  padd <- padd/2
  
  if(is.null(col)&is.null(dat$col)){
    col <- rep('royalblue', nr)
  }
  col <- rep(col, nr)
  if(!is.list(pos))
    pos <- list(pos)
  pos <- rep(pos, nr)
  
  offset <- rep(offset,nr)
  bw <- rep(band.width, nr)
  lab.col <- rep(lab.col, nr)
  
  if(!add){
    # prepare plot window
    plot(NULL, yaxt='n', ylab='', cex=cex,
         ylim=ylim, xlim=xlim,
         xlab=xlab, main=main)
  }
  
  # draw polygons & labels
  invisible(sapply(seq_len(nr), function(i){
    x0 <- dat$start[i] + padd
    x1 <- dat$end[i] - padd
    y0 <- dat$row[i] - bw[i]/2
    y1 <- y0 + bw[i]
    
    polygon(c(x0, x0, x1, x1), 
            c(y0, y1, y1, y0), 
            border = NA, col=col[i])

    if(!is.null(dat$labels)){
      text((x0+x1)/2, (y0+y1)/2, font = 2, 
           pos=pos[[i]], offset = offset, cex=cex,
           labels = dat$labels[i], col=lab.col[i])
    }
    
  }))
  
}


dev.stages1 <- data.frame(
  labels = c("L1", "L2", "L3", "L4", "Young Adult", 
              "Adult"),
  start = c(0, 20, 30, 38, 50, 70),
  end = c(20, 30, 38, 50, 70, 85),
  row = rep(1, 6)
)

ref.data1 <- data.frame(
  labels = c("Oudenaarden time series", 
             "Reinke time series"),
  start = c(0, 30),
  end = c(48, 85),
  row = c(2.9,3.8)
)
dev.stages2 <- data.frame(
  labels = c("1C", "2C", "4C", "Gastrulation", 
             "Comma", "2-fold","4-fold"),
  start = c(-50, -20, 0, 150, 
            400, 460, 520),
  end = c(-20, 0, 20, 350, 460, 520, 600),
  row = rep(1, 7)
)
ref.data2 <- data.frame(
  labels = c("Hashimshony time series"),
  start = c(-50),
  end = c(830),
  row = c(3)
)

cc <- .75

par(mar=c(4,5,4,2), mfrow=c(2,1))
timeline(dev.stages1, ylim=c(0,5), padd = .8, cex=cc,
         main="Larval to adult development",
         xlab="Time from hatching (h)")
timeline(ref.data1, add=T, band.width = .7, cex=cc,
         col='firebrick')
mtext(text = c("Dev. stage", "Ref. dataset"), cex = cc,
      side = 2, at = c(1,3.4), las=2, line = .4)


timeline(dev.stages2, ylim=c(0,4), xlim=c(-50, 830), cex=cc,
         main="Embryonic development",
         padd = 3, xlab = "Time from 4-Cell embryo (min)",
         pos=list(3,1,3, NULL, 1,3,1), offset = .75,
         lab.col = c(rep('black',3), 'white', rep('black',3)))
timeline(ref.data2, add=T, band.width = .7, col='firebrick', cex=cc)
mtext(text = c("Dev. stage", "Ref. dataset"), cex = cc,
      side = 2, at = c(1,3), las=2, line = .4)
```

Notice the overlap between the Reinke and the Oudenaarden data series. 
If your samples are in this overlap, preferentially use the Oudenaarden reference data, as it is much cleaner (and more recent).

### Loading the data
To get precise estimates, `wormAge` interpolates on the dynamics of gene expression of the reference series to increase resolution.
You can load a reference dataset with optimal parameters using the `prepare_refdata()` function.

For our example, the Reinke dataset is appropriate since our samples go from late L3 to young adult.
```{r prep_ref}
ref <- prepare_refdata("reinke")
```




## Performing the age estimate
We'll select the non-dauer and N2 worms from our dataset to age and run the `estimate.worm_age()` function.

```{r perform_ae}
sel <- pheno.hendriks$`growth protocol:ch1`=="Continuous" & # select non-dauer
  pheno.hendriks$`strain:ch1`=="N2" # select N2s

ae_hendriks <- estimate.worm_age(samp = geno.hendriks[, sel], 
                                 refdata = ref$interpol.gene_expr,
                                 ref.time_series = ref$time.series)
```



## Understanding the output
The output of the `estimate.worm_age()` is an `ae` object including various elements such as the age estimate and a 95% confidence interval obtained through booststrapping (age estimate on random gene subsets).

<br>
General information can be accessed via the `summary()` function.
```{r summ_ae}
summary(ae_hendriks)
```

<br>
If you want to retreive the estimates and their confidence intervals, they are accessible through `$age.estimates`.
```{r show_ae}
head(ae_hendriks$age.estimates)
```

The table holds the following :

 - `age.estimate`, the global estimate (whole gene set)
 - `2.5%`, the lower bound of the bootstrapped age estimates' confidence interval
 - `97.5%`, the upper bound...
 - `cor.score`, the correlation score of the global estimate
 - `IC.imbalance`, ratio of distances between global estimate and bounds of the interval ; if this value is above 5, it usually means that the bootstrap estimates 'jump' between two very different correlation peaks, in which case a warning is given in the `summary`

### Plots

Estimates and confidence intervals can also be displayed in the form of a dotchart with the default plot function.

```{r plot_ae, fig.height=5, fig.width=7, fig.align='center'}
plot(ae_hendriks, main="Age estimates on Hendriks development series")
```


The `ae` object also holds the correlation scores of the samples against the reference series and their 95% intervals accross the bootstrap. 
You can also plot these correlation profiles with `plot_cor.ae()`

```{r plot_cor, fig.height=4, fig.width=7, fig.align='center'}
par(mfrow=c(2,2))
plot_cor.ae(ae_hendriks, subset = 7:10)
```

If we zoom on these plots, we'll see that the 95 % interval is represented for both the estimate (red bars) and the correlation scores (black dotted lines). 
The global estimate is also given below the interval.

```{r plot_cor_zoom, fig.height=3, fig.width=7, fig.align='center'}
par(mfrow=c(1,2))
plot_cor.ae(ae_hendriks, subset = 11:12, xlim=c(40,55))
```


