```{r, include = FALSE, eval = T}
knitr::opts_knit$set(out.format = "html", header = "")
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  out.width = '100%'
)
options(width=100)

gen_figs <- F
figpath <- "../inst/cdoc/RAPToR-showcase_figs/"
if(!file.exists(figpath)){
  dir.create(figpath)
}


library(RAPToR)
library(RColorBrewer)
library(beeswarm)
library(parallel)
# library(vioplot)

library(limma)
requireNamespace("wormRef")
library(stats)

transp <- function(col, a=.5){
  colr <- col2rgb(col)
  return(rgb(colr[1,], colr[2,], colr[3,], a*255, maxColorValue = 255))
}

png_custom <- function(figname, path = "", 
                       fig.width = 7, fig.height = 5, res = 150, ...){
  png(filename = paste0(path, figname, ".png"), 
      width = fig.width, height = fig.height, res = res, units = "in")
}

show_fig <- function(figname = knitr::opts_current$get("label"), expr, path = figpath, ...){
  if(gen_figs){
    png_custom(figname = figname, path = figpath, ...)
    eval(expr = expr)
    dev.off()
  }
  else{
    knitr::include_graphics(paste0(path, figname, ".png"))
  }
}
```

Let's perform tissue-specific staging.

### The data

We'll be working with a dataset published by @rockman2010selection.  

This dataset correpsonds to microarray profiling of 208 recombinant inbred lines of *C. elegans* N2 and Hawaii (CB4856) strains. 
These 208 samples were described as *"developmentally synchronized"* in the original paper. 
However, it was later demonstrated that a very significant developmental spread of the samples existed, spanning around 20 hours of $20^\circ C$ late larval development existed (@francesconi2014effects).

This essentially makes this dataset a very high-resolution timecourse of late-larval development.

<br>




In *C. elegans*, there is a known heterochrony of soma and germline development.  

<!-- dsperez2017 -->

<!-- ```{r load_dsperez2017_c, eval = F} -->
<!-- geo_dsperez2017 <- "GSE98747" -->

<!-- geo_dsperez2017 <- GEOquery::getGEO(geo_dsperez2017)[[1]] -->
<!-- X_dsperez2017 <- Biobase::exprs(geo_dsperez2017) -->



<!-- gpl_23457 <- GEOquery::getGEO("GPL23457") -->
<!-- probe_ids <- GEOquery::Table(gpl_23457) -->

<!-- X_dsperez2017 <- format_ids(X_dsperez2017, probe_ids, from = "ID", to = "WbID")[-(1:2),] -->

<!-- P_dsperez2017 <- Biobase::pData(geo_dsperez2017) -->
<!-- P_dsperez2017 <- P_dsperez2017[, c("title", "geo_accession", "batch:ch1", "protocol:ch1")] -->
<!-- colnames(P_dsperez2017)[3:4] <- c("batch", "protocol") -->

<!-- P_dsperez2017$batch <- as.factor(P_dsperez2017$batch) -->
<!-- P_dsperez2017$title <- as.character(P_dsperez2017$title) -->
<!-- X_dsperez2017 <- X_dsperez2017[, P_dsperez2017$geo_accession] -->

<!-- dsperez2017 <- list(g = X_dsperez2017, p = P_dsperez2017) -->

<!-- save(dsperez2017, file = "../inst/extdata/dsperez2017.RData") -->

<!-- rm(P_dsperez2017, X_dsperez2017, geo_dsperez2017, gpl_23457, probe_ids) -->
<!-- ``` -->



```{r sc3_load_rockman_c, eval = F}
geo_dsrockman <- "GSE23857"
geo_dsrockman <- GEOquery::getGEO(geo_dsrockman, GSEMatrix = F)

# get pdata
P_dsrockman <- do.call(rbind, lapply(GEOquery::GSMList(geo_dsrockman), function(go){
  unlist(GEOquery::Meta(go)[
    c("geo_accession", "characteristics_ch1", "characteristics_ch2",
      "label_ch1", "label_ch2")]
  )
}))

P_dsrockman <- as.data.frame(P_dsrockman, stringsAsFactors = F)

# get RG data from microarray
RG_dsrockman <- list(
  R = do.call(cbind, lapply(GEOquery::GSMList(geo_dsrockman), function(go){
      GEOquery::Table(go)[, "R_MEAN_SIGNAL"]
    })),
  G = do.call(cbind, lapply(GEOquery::GSMList(geo_dsrockman), function(go){
    GEOquery::Table(go)[, "G_MEAN_SIGNAL"]
  }))
)

# normalize within channels
RG_dsrockman <- limma::normalizeWithinArrays(RG_dsrockman, method = "loess")
RG_dsrockman <- limma::RG.MA(RG_dsrockman) # convert back from MA to RG

# get only the RIALs (not the mixed stage controls)
X_dsrockman <- RG_dsrockman$R
X_dsrockman[, P_dsrockman$label_ch1 == "Cy5"] <- RG_dsrockman$G[, P_dsrockman$label_ch1 == "Cy5"]

# format probe/gene ids
gpl <- GEOquery::getGEO(GEOquery::Meta(GEOquery::GSMList(geo_dsrockman)[[1]])$platform_id)
gpl <- GEOquery::Table(gpl)
gpl <- gpl[as.character(gpl$ID) %in% as.character(GEOquery::Table(GEOquery::GSMList(geo_dsrockman)[[1]])$ID_REF), ]

sel <- gpl$ORF%in%wormRef::Cel_genes$sequence_name
gpl <- gpl[sel,]
X_dsrockman <- X_dsrockman[sel,]


# filter bad quality samples
cm_dsrockman <- cor(log1p(X_dsrockman), method = 'spearman')
f_dsrockman <- which(0.95 > apply(cm_dsrockman, 1, quantile, probs = .95))

X_dsrockman <- X_dsrockman[,-f_dsrockman]
P_dsrockman <- P_dsrockman[-f_dsrockman,]

rownames(X_dsrockman) <- gpl$ORF
X_dsrockman <- RAPToR::format_ids(X_dsrockman, wormRef::Cel_genes, 
                                  from = "sequence_name", to = "wb_id")


dsrockman <- list(g = X_dsrockman, p = P_dsrockman)

save(dsrockman, file = "../inst/extdata/dsrockman.RData", compress = "xz")
rm(geo_dsrockman, gpl, sel, RG_dsrockman, X_dsrockman, P_dsrockman, 
   cm_dsrockman, f_dsrockman)
```


```{r sc3_load_genesets_c, eval = F}
library(readxl)
germline_url <- "https://static-content.springer.com/esm/art%3A10.1038%2Fnature25012/MediaObjects/41586_2017_BFnature25012_MOESM3_ESM.xlsx"
germline_file <- "../inst/extdata/germline_gset.xlsx"
utils::download.file(url = germline_url, destfile = germline_file)

germline_set <- read_xlsx(germline_file, sheet = 3, na = "NA")[,c(1, 44:46)]
germline_set <- cbind(wb_id = germline_set[,1], 
                      germline = apply(germline_set[, 2:4], 1, function(r) any(r)))
germline_set$germline[is.na(germline_set$germline)] <- FALSE
germline_set <- germline_set[germline_set$germline,1]

soma_url <- "https://ars.els-cdn.com/content/image/1-s2.0-S1097276513009039-mmc2.xlsx"
soma_file <- "../inst/extdata/soma_gset.xlsx"
utils::download.file(url = soma_url, destfile = soma_file)

soma_set <- read_xlsx(soma_file, skip = 3, na = "NA")[,c(1, 4)]
soma_set$class <- factor(soma_set$class)

soma_set$soma <- soma_set$class == "osc"
soma_set <- soma_set[soma_set$soma, 1]

gsubset <- list(germline = germline_set, soma = soma_set$`Gene WB ID`)

save(gsubset, file = "../inst/extdata/sc3_gsubset.RData", compress = "xz")

file.remove(germline_file)
file.remove(soma_file)
rm(germline_url, germline_file, germline_set, soma_url, soma_file, soma_set)
```


```{r sc_3_load_ds, include = F, eval = gen_figs}
load("../inst/extdata/dsperez2017.RData")
load("../inst/extdata/dsrockman.RData")
load("../inst/extdata/sc3_gsubset.RData")
```


```{r sc3_qnorm, eval=gen_figs}
dsperez2017$g <- 2^dsperez2017$g # data is given as log2
dsperez2017$g <- limma::normalizeBetweenArrays(dsperez2017$g, method = "quantile")
dsperez2017$g <- log(dsperez2017$g + 1)

dsrockman$g <- limma::normalizeBetweenArrays(dsrockman$g, method = "quantile")
dsrockman$g <- log(dsrockman$g + 1)
```

```{r sc3_ae, eval = gen_figs}
r_ya <- prepare_refdata("Cel_YA_1", "wormRef", n.inter = 400)

# ae_dsperez <- ae(dsperez2017$g, r_ya$interpGE, r_ya$time.series)
ae_dsrockman <- ae(dsrockman$g, r_ya$interpGE, r_ya$time.series, bootstrap.n = 10)
```

```{r sc3_plot_ae, echo = F}
# plot(ae_dsperez, show.boot_estimates = T, group = dsperez2017$p$batch)
plot(ae_dsrockman)
```


```{r sc3_ql, eval = gen_figs, fig.height=3, fig.width=15}
pca_rock <- stats::prcomp(dsrockman$g, rank = 5)

par(mfrow = c(1,5))
invisible(sapply(seq_len(5), function(i){
  plot(ae_dsrockman$age.estimates[,1], pca_rock$rotation[,i], main = paste("PC", i), 
       ylab = "PC", xlab = "age")
}))
```

```{r sc3_ql2, fig.height=3, fig.width=15}
ica_rock <- ica::icafast(dsrockman$g, nc = 5)

par(mfrow = c(1,5))
invisible(sapply(seq_len(5), function(i){
  plot(ae_dsrockman$age.estimates[,1], ica_rock$M[,i], main = paste("IC", i), 
       ylab = "IC", xlab = "age")
}))
```



```{r ae_soma_germline}
ae_soma <- ae(dsrockman$g[rownames(dsrockman$g)%in%gsubset$soma,], 
                      r_ya$interpGE, r_ya$time.series)

ae_germline <- ae(dsrockman$g[rownames(dsrockman$g)%in%gsubset$germline,], 
                  r_ya$interpGE, r_ya$time.series)

```

```{r sc3_plot_aevs, fig.height=4, fig.width=12}
par(mfrow = c(1,3))
rg <- c(40,70)

plot(ae_dsrockman$age.estimates[,1], ae_soma$age.estimates[,1], lwd = 2, col = "firebrick",
     xlab = "Global age", ylab = "Soma age", main = "Global vs. Soma age",
     xlim = rg, ylim = rg)
box(lwd = 2, col = "firebrick")
abline(a = 0, b = 1, lty = 2, col = "firebrick")

plot(ae_dsrockman$age.estimates[,1], ae_germline$age.estimates[,1], lwd = 2, col = "royalblue",
     xlab = "Global age", ylab = "Germline age", main = "Global vs. Germline age",
     xlim = rg, ylim = rg)
box(lwd = 2, col = "royalblue")
abline(a = 0, b = 1, lty = 2, col = "royalblue")


plot(ae_soma$age.estimates[,1], ae_germline$age.estimates[,1], lwd = 2, 
     xlim = rg, ylim = rg,
     xlab = "Soma age", ylab = "Germline age", main = "Soma vs. Germline age")
abline(a = 0, b = 1, lty = 2, col = "black")


```


```{r fig.height=6, fig.width=15}
par(mfcol = c(2,5))
  invisible(sapply(seq_len(5), function(i){
    plot(ae_soma$age.estimates[,1], ica_rock$M[,i], lwd = 2, col = "firebrick",
         xlab = "ae", ylab = "IC", main = paste0("(soma) IC", i))
    box(lwd = 2, col = "firebrick")
    
    plot(ae_germline$age.estimates[,1], ica_rock$M[,i], lwd = 2, col = "royalblue",
         xlab = "ae", ylab = "IC", main = paste0("(germline) IC", i))
    box(lwd = 2, col = "royalblue")
}))
```



